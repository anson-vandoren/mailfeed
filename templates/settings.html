{% extends "base.html" %}

{% block title %}Settings - Mailfeed{% endblock %}

{% block content %}
<nav class="main-nav" role="navigation" aria-label="Main navigation">
    <div class="nav-container">
        <a href="/dashboard" class="nav-brand" aria-label="MailFeed Dashboard">
            <span class="brand-icon">ğŸ“°</span>
            <span>MailFeed</span>
        </a>
        
        <div class="nav-actions">
            <button onclick="toggleTheme()" 
                    class="theme-toggle"
                    aria-label="Toggle dark/light theme"
                    title="Toggle theme">
                <span class="nav-icon">ğŸŒ“</span>
                <span class="nav-text">Theme</span>
            </button>
            
            <a href="/dashboard" class="nav-link" aria-label="Dashboard">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-text">Dashboard</span>
            </a>
            
            <button hx-post="/auth/logout" 
                    hx-target="#main"
                    hx-confirm="Are you sure you want to log out?"
                    class="nav-button"
                    aria-label="Logout">
                <span class="nav-icon">ğŸšª</span>
                <span class="nav-text">Logout</span>
            </button>
        </div>
    </div>
</nav>

    <!-- Main content -->
    <main class="container">
        <h1>âš™ï¸ User Settings</h1>
        <p>Manage your personal settings and preferences</p>

        <!-- Messages Area -->
        <div id="settings-messages"></div>

        <!-- User Profile Section -->
        <section>
            <h2>ğŸ‘¤ Profile</h2>
            
            <form hx-patch="/api/users/{{ user.id }}" 
                  hx-target="#settings-messages"
                  hx-swap="innerHTML">
                
                <div class="grid">
                    <label>
                        Email Address
                        <input type="email" 
                               name="login_email" 
                               value="{{ user.login_email }}"
                               required>
                    </label>

                    <div>
                        <strong>Account Status:</strong>
                        {% if user.is_active %}
                            <span style="color: #10b981;">âœ… Active</span>
                        {% else %}
                            <span style="color: #ef4444;">âŒ Inactive</span>
                        {% endif %}
                    </div>

                    <div>
                        <strong>Role:</strong> {{ user.role }}
                    </div>
                </div>

                <button type="submit">ğŸ’¾ Update Profile</button>
            </form>
        </section>

        <!-- Telegram Integration Section -->
        <section>
            <h2>ğŸ“± Telegram Integration</h2>
            
            {% if let Some(chat_id) = user.telegram_chat_id %}
            <div>
                <div style="padding: 1rem; background: #d1fae5; border: 1px solid #10b981; border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #065f46;">âœ… Telegram Connected</h4>
                    <p style="margin: 0; font-size: 0.875rem; color: #047857;">
                        <strong>Chat ID:</strong> <code>{{ chat_id }}</code><br>
                        {% if let Some(username) = user.telegram_username %}
                        <strong>Username:</strong> @{{ username }}
                        {% endif %}
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button hx-post="/api/users/{{ user.id }}/test-telegram"
                            hx-target="#settings-messages"
                            hx-swap="innerHTML"
                            class="secondary">
                        ğŸ§ª Send Test Message
                    </button>
                    
                    <button onclick="document.getElementById('telegram-edit-form').style.display = 'block'; this.style.display = 'none';"
                            class="secondary">
                        âœï¸ Edit Settings
                    </button>
                    
                    <form hx-patch="/api/users/{{ user.id }}" 
                          hx-target="#settings-messages"
                          hx-swap="innerHTML"
                          style="display: inline;">
                        <input type="hidden" name="telegram_chat_id" value="">
                        <input type="hidden" name="telegram_username" value="">
                        <button type="submit" class="contrast">
                            ğŸ”Œ Disconnect Telegram
                        </button>
                    </form>
                </div>
                
                <!-- Edit form (hidden by default) -->
                <form id="telegram-edit-form" 
                      hx-patch="/api/users/{{ user.id }}" 
                      hx-target="#settings-messages"
                      hx-swap="innerHTML"
                      style="display: none; margin-top: 1rem; padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: var(--pico-border-radius);">
                    
                    <h4 style="margin: 0 0 1rem 0;">Edit Telegram Settings</h4>
                    
                    <div class="grid">
                        <label>
                            Telegram Chat ID *
                            <input type="text" 
                                   name="telegram_chat_id" 
                                   value="{{ chat_id }}"
                                   placeholder="e.g., 123456789"
                                   pattern="[0-9\-]+"
                                   title="Numeric chat ID"
                                   required>
                            <small>Send a message to your bot to get this ID</small>
                        </label>

                        <label>
                            Telegram Username
                            <input type="text" 
                                   name="telegram_username" 
                                   value="{% if let Some(username) = user.telegram_username %}{{ username }}{% endif %}"
                                   placeholder="e.g., username">
                            <small>Optional - for display purposes only</small>
                        </label>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button type="submit">ğŸ’¾ Update Settings</button>
                        <button type="button" 
                                onclick="document.getElementById('telegram-edit-form').style.display = 'none';"
                                class="secondary">
                            âœ–ï¸ Cancel
                        </button>
                    </div>
                </form>
            </div>
            {% else %}
            <div>
                <div style="padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">âš ï¸ Telegram Not Connected</h4>
                    <p style="margin: 0 0 0.5rem 0; color: #92400e;">Connect your Telegram account to receive feed updates via Telegram.</p>
                    <div style="font-size: 0.875rem; color: #92400e;">
                        <p><strong>How to connect:</strong></p>
                        <ol style="margin: 0.5rem 0 0 1.5rem;">
                            <li>Start a chat with your bot on Telegram</li>
                            <li>Send any message to get your chat ID</li>
                            <li>Enter the chat ID below</li>
                        </ol>
                    </div>
                </div>
                
                <form hx-patch="/api/users/{{ user.id }}" 
                      hx-target="#settings-messages"
                      hx-swap="innerHTML">
                    
                    <div class="grid">
                        <label>
                            Telegram Chat ID *
                            <input type="text" 
                                   name="telegram_chat_id" 
                                   placeholder="e.g., 123456789"
                                   pattern="[0-9-]+"
                                   title="Numeric chat ID"
                                   required>
                            <small>Send a message to your bot to get this ID</small>
                        </label>

                        <label>
                            Telegram Username
                            <input type="text" 
                                   name="telegram_username" 
                                   placeholder="e.g., username">
                            <small>Optional - for display purposes only</small>
                        </label>
                    </div>

                    <button type="submit">ğŸ”— Connect Telegram</button>
                </form>
            </div>
            {% endif %}
        </section>

        <!-- System Configuration (Admin Only) -->
        {% if user.role == "admin" %}
        <section>
            <h2>ğŸ”§ System Configuration</h2>
            
            <div style="padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">âš ï¸ Admin Only</h4>
                <p style="margin: 0; color: #92400e;">These settings affect the entire system and require admin privileges.</p>
            </div>
            
            <div>
                <h3>ğŸ¤– Telegram Bot Token</h3>
                <p>Bot token for system-wide Telegram integration. Get this from <a href="https://t.me/BotFather" target="_blank">@BotFather</a>.</p>
                
                <form hx-patch="/api/config/telegram_bot_token"
                      hx-target="#settings-messages"
                      hx-swap="innerHTML">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: end;">
                        <input type="password"
                               name="value"
                               placeholder="Bot token from @BotFather"
                               pattern="[0-9]+:[A-Za-z0-9_\-]+"
                               title="Format: 123456789:ABCdefGHIjklMNOpqrSTUvwxyz">
                        <button type="submit">ğŸ’¾ Save Token</button>
                    </div>
                    
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--pico-muted-color);">
                        Enter the bot token to enable Telegram integration for all users
                    </div>
                </form>
            </div>
        </section>
        {% endif %}

    </main>
{% endblock %}