{% extends "base.html" %}

{% block title %}Settings - Mailfeed{% endblock %}

{% block content %}
<nav class="main-nav" role="navigation" aria-label="Main navigation">
    <div class="nav-container">
        <a href="/dashboard" class="nav-brand" aria-label="MailFeed Dashboard">
            <span class="brand-icon">📰</span>
            <span>MailFeed</span>
        </a>
        
        <div class="nav-actions">
            <button onclick="toggleTheme()" 
                    class="theme-toggle"
                    aria-label="Toggle dark/light theme"
                    title="Toggle theme">
                <span class="nav-icon">🌓</span>
                <span class="nav-text">Theme</span>
            </button>
            
            <a href="/dashboard" class="nav-link" aria-label="Dashboard">
                <span class="nav-icon">🏠</span>
                <span class="nav-text">Dashboard</span>
            </a>
            
            <button hx-post="/auth/logout" 
                    hx-target="#main"
                    class="nav-button"
                    aria-label="Logout">
                <span class="nav-icon">🚪</span>
                <span class="nav-text">Logout</span>
            </button>
        </div>
    </div>
</nav>

    <!-- Main content -->
    <main class="container">
        <h1>⚙️ User Settings</h1>
        <p>Manage your personal settings and preferences</p>

        <!-- Messages Area -->
        <div id="settings-messages"></div>

        <!-- User Profile Section -->
        <section>
            <h2>👤 Profile</h2>
            
            <form hx-patch="/api/users/{{ user.id }}" 
                  hx-target="#settings-messages"
                  hx-swap="innerHTML">
                
                <div class="grid">
                    <label>
                        Email Address
                        <input type="email" 
                               name="login_email" 
                               value="{{ user.login_email }}"
                               required>
                    </label>

                    <div>
                        <strong>Account Status:</strong>
                        {% if user.is_active %}
                            <span style="color: #10b981;">✅ Active</span>
                        {% else %}
                            <span style="color: #ef4444;">❌ Inactive</span>
                        {% endif %}
                    </div>

                    <div>
                        <strong>Role:</strong> {{ user.role }}
                    </div>
                </div>

                <button type="submit">💾 Update Profile</button>
            </form>
        </section>

        <!-- Telegram Integration Section -->
        <section>
            <h2>📱 Telegram Integration</h2>
            
            {% if let Some(chat_id) = user.telegram_chat_id %}
            <div>
                <div style="padding: 1rem; background: #d1fae5; border: 1px solid #10b981; border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #065f46;">✅ Telegram Connected</h4>
                    <p style="margin: 0; font-size: 0.875rem; color: #047857;">
                        <strong>Chat ID:</strong> <code>{{ chat_id }}</code><br>
                        {% if let Some(username) = user.telegram_username %}
                        <strong>Username:</strong> @{{ username }}
                        {% endif %}
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button hx-post="/api/users/{{ user.id }}/test-telegram"
                            hx-target="#settings-messages"
                            hx-swap="innerHTML"
                            class="secondary">
                        🧪 Send Test Message
                    </button>
                    
                    <button onclick="document.getElementById('telegram-edit-form').style.display = 'block'; this.style.display = 'none';"
                            class="secondary">
                        ✏️ Edit Settings
                    </button>
                    
                    <form hx-patch="/api/users/{{ user.id }}" 
                          hx-target="#settings-messages"
                          hx-swap="innerHTML"
                          style="display: inline;">
                        <input type="hidden" name="telegram_chat_id" value="">
                        <input type="hidden" name="telegram_username" value="">
                        <button type="submit" class="contrast">
                            🔌 Disconnect Telegram
                        </button>
                    </form>
                </div>
                
                <!-- Edit form (hidden by default) -->
                <form id="telegram-edit-form" 
                      hx-patch="/api/users/{{ user.id }}" 
                      hx-target="#settings-messages"
                      hx-swap="innerHTML"
                      style="display: none; margin-top: 1rem; padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: var(--pico-border-radius);">
                    
                    <h4 style="margin: 0 0 1rem 0;">Edit Telegram Settings</h4>
                    
                    <div class="grid">
                        <label>
                            Telegram Chat ID *
                            <input type="text" 
                                   name="telegram_chat_id" 
                                   value="{{ chat_id }}"
                                   placeholder="e.g., 123456789"
                                   pattern="[0-9\-]+"
                                   title="Numeric chat ID"
                                   required>
                            <small>Send a message to your bot to get this ID</small>
                        </label>

                        <label>
                            Telegram Username
                            <input type="text" 
                                   name="telegram_username" 
                                   value="{% if let Some(username) = user.telegram_username %}{{ username }}{% endif %}"
                                   placeholder="e.g., username">
                            <small>Optional - for display purposes only</small>
                        </label>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button type="submit">💾 Update Settings</button>
                        <button type="button" 
                                onclick="document.getElementById('telegram-edit-form').style.display = 'none';"
                                class="secondary">
                            ✖️ Cancel
                        </button>
                    </div>
                </form>
            </div>
            {% else %}
            <div>
                <div style="padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">⚠️ Telegram Not Connected</h4>
                    <p style="margin: 0 0 0.5rem 0; color: #92400e;">Connect your Telegram account to receive feed updates via Telegram.</p>
                    <div style="font-size: 0.875rem; color: #92400e;">
                        <p><strong>How to connect:</strong></p>
                        <ol style="margin: 0.5rem 0 0 1.5rem;">
                            <li>Start a chat with your bot on Telegram</li>
                            <li>Send any message to get your chat ID</li>
                            <li>Enter the chat ID below</li>
                        </ol>
                    </div>
                </div>
                
                <form hx-patch="/api/users/{{ user.id }}" 
                      hx-target="#settings-messages"
                      hx-swap="innerHTML">
                    
                    <div class="grid">
                        <label>
                            Telegram Chat ID *
                            <input type="text" 
                                   name="telegram_chat_id" 
                                   placeholder="e.g., 123456789"
                                   pattern="[0-9-]+"
                                   title="Numeric chat ID"
                                   required>
                            <small>Send a message to your bot to get this ID</small>
                        </label>

                        <label>
                            Telegram Username
                            <input type="text" 
                                   name="telegram_username" 
                                   placeholder="e.g., username">
                            <small>Optional - for display purposes only</small>
                        </label>
                    </div>

                    <button type="submit">🔗 Connect Telegram</button>
                </form>
            </div>
            {% endif %}
        </section>

        <!-- Email Delivery Section -->
        <section>
            <h2>📧 Email Delivery</h2>
            
            {% if let Some(email_config) = email_config %}
            <!-- Email Configured State -->
            <div>
                <div style="padding: 1rem; background: #d1fae5; border: 1px solid #10b981; border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #065f46;">✅ Email Configured</h4>
                    <p style="margin: 0; font-size: 0.875rem; color: #047857;">
                        <strong>SMTP Host:</strong> {{ email_config.smtp_host }}:{{ email_config.smtp_port }}<br>
                        <strong>From Email:</strong> {{ email_config.from_email }}
                        {% if let Some(from_name) = email_config.from_name %}
                        <br><strong>From Name:</strong> {{ from_name }}
                        {% endif %}
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button hx-post="/api/users/{{ user.id }}/test-email"
                            hx-target="#settings-messages"
                            hx-swap="innerHTML"
                            class="secondary">
                        🧪 Send Test Email
                    </button>
                    
                    <button onclick="document.getElementById('email-edit-form').style.display = 'block'; this.style.display = 'none';"
                            class="secondary">
                        ✏️ Edit Settings
                    </button>
                    
                    <form hx-delete="/api/users/{{ user.id }}/email-config" 
                          hx-target="#settings-messages"
                          hx-swap="innerHTML"
                          style="display: inline;">
                        <button type="submit" class="contrast">
                            🔌 Remove Email Config
                        </button>
                    </form>
                </div>
            </div>
            {% else %}
            <!-- Email Not Configured State -->
            <div>
                <div style="padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">⚠️ Email Not Configured</h4>
                    <p style="margin: 0; color: #92400e;">Configure your SMTP settings to receive feed updates via email.</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Email Configuration Form -->
            <form id="email-edit-form" 
                  hx-post="/api/users/{{ user.id }}/email-config" 
                  hx-target="#settings-messages"
                  hx-swap="innerHTML"
                  {% if let Some(_) = email_config %}style="display: none;"{% endif %}>
                
                <h4>📧 SMTP Configuration</h4>
                
                <div class="grid">
                    <label>
                        SMTP Host *
                        <input type="text" name="smtp_host" 
                               value="{% if let Some(config) = email_config %}{{ config.smtp_host }}{% endif %}"
                               placeholder="smtp.gmail.com" required>
                        <small>Your email provider's SMTP server</small>
                    </label>
                    
                    <label>
                        Port
                        <input type="number" name="smtp_port" 
                               value="{% if let Some(config) = email_config %}{{ config.smtp_port }}{% else %}587{% endif %}"
                               min="1" max="65535">
                        <small>Usually 587 (TLS) or 465 (SSL)</small>
                    </label>
                </div>
                
                <div class="grid">
                    <label>
                        Username *
                        <input type="text" name="smtp_username" 
                               value="{% if let Some(config) = email_config %}{{ config.smtp_username }}{% endif %}"
                               placeholder="your-email@gmail.com" required>
                    </label>
                    
                    <label>
                        Password *
                        {% if let Some(_) = email_config %}
                        <input type="password" name="smtp_password" 
                               placeholder="••••••••">
                        {% else %}
                        <input type="password" name="smtp_password" 
                               placeholder="App password or email password" required>
                        {% endif %}
                        <small>Use app-specific passwords for Gmail/Outlook</small>
                    </label>
                </div>
                
                <div class="grid">
                    <label>
                        From Email *
                        <input type="email" name="from_email" 
                               value="{% if let Some(config) = email_config %}{{ config.from_email }}{% endif %}"
                               placeholder="feeds@yourdomain.com" required>
                    </label>
                    
                    <label>
                        From Name
                        <input type="text" name="from_name" 
                               value="{% if let Some(config) = email_config %}{% if let Some(from_name) = config.from_name %}{{ from_name }}{% endif %}{% endif %}"
                               placeholder="MailFeed Updates">
                    </label>
                </div>
                
                <label>
                    {% if let Some(config) = email_config %}
                    <input type="checkbox" name="smtp_use_tls" {% if config.smtp_use_tls %}checked{% endif %}> 
                    {% else %}
                    <input type="checkbox" name="smtp_use_tls" checked> 
                    {% endif %}
                    Use TLS encryption (recommended)
                </label>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button type="submit">💾 {% if let Some(_) = email_config %}Update{% else %}Save{% endif %} Email Config</button>
                    {% if let Some(_) = email_config %}
                    <button type="button" 
                            onclick="document.getElementById('email-edit-form').style.display = 'none';"
                            class="secondary">
                        ✖️ Cancel
                    </button>
                    {% endif %}
                </div>
            </form>
        </section>

        <!-- System Configuration (Admin Only) -->
        {% if user.role == "admin" %}
        <section>
            <h2>🔧 System Configuration</h2>
            
            <div style="padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">⚠️ Admin Only</h4>
                <p style="margin: 0; color: #92400e;">These settings affect the entire system and require admin privileges.</p>
            </div>
            
            <div>
                <h3>🤖 Telegram Bot Token</h3>
                <p>Bot token for system-wide Telegram integration. Get this from <a href="https://t.me/BotFather" target="_blank">@BotFather</a>.</p>
                
                <form hx-patch="/api/config/telegram_bot_token"
                      hx-target="#settings-messages"
                      hx-swap="innerHTML">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: end;">
                        <input type="password"
                               name="value"
                               placeholder="Bot token from @BotFather"
                               pattern="[0-9]+:[A-Za-z0-9_\-]+"
                               title="Format: 123456789:ABCdefGHIjklMNOpqrSTUvwxyz">
                        <button type="submit">💾 Save Token</button>
                    </div>
                    
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--pico-muted-color);">
                        Enter the bot token to enable Telegram integration for all users
                    </div>
                </form>
            </div>
        </section>
        {% endif %}

    </main>
{% endblock %}